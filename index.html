<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App with Parameters</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 16px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        .param-card {
            background-color: var(--tg-theme-secondary-bg-color, #f3f3f3);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        pre {
            white-space: pre-wrap;
            word-wrap: break-word;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>参数接收演示</h1>
        
        <div class="param-card">
            <h3>URL参数</h3>
            <div id="url-params"></div>
        </div>
        
        <div class="param-card">
            <h3>Telegram WebApp 数据</h3>
            <div id="webapp-data"></div>
        </div>
        
        <div class="param-card">
            <h3>初始化数据验证</h3>
            <div id="init-data-result"></div>
        </div>
    </div>

    <script>
        // 1. 获取URL参数
        function getUrlParams() {
            const params = new URLSearchParams(window.location.search);
            const result = {};
            for (const [key, value] of params.entries()) {
                if (key !== 'initData') {
                    result[key] = value;
                }
            }
            return result;
        }
        
        // 2. 显示Telegram WebApp数据
        function displayWebAppData() {
            if (window.Telegram && window.Telegram.WebApp) {
                const tg = Telegram.WebApp;
                const data = {
                    initData: tg.initData,
                    initDataUnsafe: tg.initDataUnsafe,
                    themeParams: tg.themeParams,
                    platform: tg.platform,
                    version: tg.version
                };
                document.getElementById('webapp-data').innerHTML = 
                    `<pre>${JSON.stringify(data, null, 2)}</pre>`;
            }
        }
        
        // 3. 验证初始化数据
        async function validateInitData() {
            const params = new URLSearchParams(window.location.search);
            const initDataStr = params.get('initData');
            
            if (!initDataStr) {
                document.getElementById('init-data-result').innerHTML = 
                    '<p>没有找到初始化数据</p>';
                return;
            }
            
            try {
                const initData = new URLSearchParams(initDataStr);
                const hash = initData.get('hash');
                
                // 准备验证数据
                const dataToCheck = [];
                initData.forEach((val, key) => {
                    if (key !== 'hash') {
                        dataToCheck.push(`${key}=${val}`);
                    }
                });
                dataToCheck.sort();
                
                // 使用Web Crypto API验证
                const encoder = new TextEncoder();
                const secretKey = await crypto.subtle.importKey(
                    'raw',
                    encoder.encode('WebAppData'),
                    { name: 'HMAC', hash: 'SHA-256' },
                    false,
                    ['verify']
                );
                
                const isValid = await crypto.subtle.verify(
                    'HMAC',
                    secretKey,
                    hexToBytes(hash),
                    encoder.encode(dataToCheck.join('\n'))
                );
                
                if (isValid) {
                    const user = initData.get('user') ? JSON.parse(initData.get('user')) : null;
                    document.getElementById('init-data-result').innerHTML = `
                        <p style="color: green;">✅ 验证成功</p>
                        <pre>${JSON.stringify({
                            user: user,
                            query_id: initData.get('query_id'),
                            auth_date: new Date(initData.get('auth_date') * 1000)
                        }, null, 2)}</pre>
                    `;
                } else {
                    document.getElementById('init-data-result').innerHTML = 
                        '<p style="color: red;">❌ 签名验证失败</p>';
                }
            } catch (e) {
                console.error('验证错误:', e);
                document.getElementById('init-data-result').innerHTML = `
                    <p style="color: red;">❌ 验证过程中出错: ${e.message}</p>
                `;
            }
        }
        
        function hexToBytes(hex) {
            const bytes = new Uint8Array(hex.length / 2);
            for (let i = 0; i < hex.length; i += 2) {
                bytes[i/2] = parseInt(hex.substr(i, 2), 16);
            }
            return bytes;
        }
        
        // 初始化应用
        document.addEventListener('DOMContentLoaded', async () => {
            // 显示URL参数
            const urlParams = getUrlParams();
            document.getElementById('url-params').innerHTML = 
                `<pre>${JSON.stringify(urlParams, null, 2)}</pre>`;
            
            // 显示WebApp数据
            displayWebAppData();
            
            // 验证初始化数据
            await validateInitData();
            
            // 初始化Telegram WebApp
            if (window.Telegram && window.Telegram.WebApp) {
                Telegram.WebApp.ready();
                Telegram.WebApp.expand();
            }
        });
    </script>
</body>
</html>
